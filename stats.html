<!DOCTYPE html>
<!--
修复说明:
1. 修改API端点配置，使用服务器端口22223
2. 确保avgTimeSpent值正确转换为数值类型
3. 添加详细日志记录，便于调试
4. 增加XMLHttpRequest备用方案，提高请求成功率
5. 优化模块使用频率图表，降低标签显示阈值至3%
6. 修复使用时段分布图，每3小时显示一个x轴标签避免重叠
-->
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统使用统计 - 经济犯罪侦查工作平台</title>
  <!-- 本地 Font Awesome 样式 -->
  <link href="assets/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --police-blue:#1a3e72;
      --police-light:#4a6fa5;
      --police-dark:#0d1f3a;
      --police-accent:#e74c3c;
      --police-success:#28a745;
      --police-warning:#ffc107;
      --police-info:#17a2b8;
      --police-gray:#f5f7fa;
      --gradient-primary:linear-gradient(135deg,var(--police-dark),var(--police-blue));
      --gradient-accent:linear-gradient(135deg,#e74c3c,#ff7675);
      --shadow-sm:0 4px 6px rgba(0,0,0,.05);
      --shadow-md:0 6px 18px rgba(0,0,0,.08);
      --shadow-lg:0 12px 24px rgba(0,0,0,.12);
      --radius-sm:8px;
      --radius-md:12px;
      --radius-lg:16px;
      --transition-fast:all 0.2s ease;
      --transition-normal:all 0.3s ease;
    }
    
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Microsoft YaHei',sans-serif;}
    
    body{
      background:var(--police-gray);
      color:var(--police-dark);
      display:flex;
      flex-direction:column;
      min-height:100vh;
      overflow-x:hidden;
    }

    /* 顶部栏 */
    .header{
      background:var(--gradient-primary);
      color:#fff;
      padding:1.2rem 2rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:var(--shadow-md);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1001;
      height: 70px;
    }
    .logo{display:flex;align-items:center;}
    .logo-icon{
      font-size:1.9rem;
      margin-right:.9rem;
      color:#fff;
      text-shadow:0 2px 4px rgba(0,0,0,0.2);
      animation:pulse 2s infinite alternate;
    }
    .title-text{
      font-size:1.45rem;
      font-weight:600;
      letter-spacing:1px;
      background:linear-gradient(45deg,#fff,#e2e8f0);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .subtitle{font-size:.85rem;opacity:.9;}
    .header-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    .back-link {
      color: white;
      font-size: 1.2rem;
      opacity: 0.9;
      transition: var(--transition-normal);
      text-decoration: none;
      padding: 0.5rem;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .back-link:hover {
      opacity: 1;
      transform: scale(1.1);
      background: rgba(255,255,255,0.2);
      box-shadow: 0 0 10px rgba(255,255,255,0.3);
    }
    #current-date {
      font-size: 0.9rem;
      background: rgba(255,255,255,0.1);
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-sm);
    }

    /* 主体内容 */
    .main-content {
      flex: 1;
      padding: 2rem;
      margin: 70px auto 0;
      max-width: 1400px;
      width: 100%;
    }

    .stats-header {
      margin: 1.5rem 0 2.5rem;
      text-align: center;
      position: relative;
    }
    .stats-title {
      font-size: 2rem;
      color: var(--police-dark);
      margin-bottom: 0.5rem;
      font-weight: 600;
      position: relative;
      display: inline-block;
    }
    .stats-title::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--police-accent);
      border-radius: 2px;
    }
    .stats-subtitle {
      font-size: 1.1rem;
      color: #666;
      margin-top: 1rem;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .stats-card {
      background: #fff;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: var(--transition-normal);
      height: 100%;
      display: flex;
      flex-direction: column;
      border-top: 4px solid var(--police-blue);
    }
    
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      background: var(--police-blue);
      color: #fff;
      padding: 1.2rem 1.5rem;
      font-weight: 600;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .card-header i {
      font-size: 1.5rem;
      opacity: 0.9;
    }

    .card-body {
      padding: 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-item {
      background: #fff;
      border-radius: var(--radius-md);
      padding: 1.5rem;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: var(--transition-normal);
      border: 1px solid rgba(0,0,0,.05);
      position: relative;
      overflow: hidden;
    }

    .stat-item:nth-child(1) {
      border-top: 3px solid var(--police-blue);
    }
    .stat-item:nth-child(2) {
      border-top: 3px solid var(--police-accent);
    }
    .stat-item:nth-child(3) {
      border-top: 3px solid var(--police-success);
    }
    .stat-item:nth-child(4) {
      border-top: 3px solid var(--police-warning);
    }

    .stat-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
      border-color: rgba(0,0,0,.1);
    }

    .stat-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 50%);
      pointer-events: none;
    }

    .stat-value {
      font-size: 2.4rem;
      font-weight: 700;
      color: var(--police-blue);
      margin-bottom: 0.5rem;
      line-height: 1;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .stat-item:nth-child(1) .stat-value {
      color: var(--police-blue);
    }
    .stat-item:nth-child(2) .stat-value {
      color: var(--police-accent);
    }
    .stat-item:nth-child(3) .stat-value {
      color: var(--police-success);
    }
    .stat-item:nth-child(4) .stat-value {
      color: var(--police-warning);
    }

    .stat-label {
      font-size: 0.95rem;
      color: #666;
      position: relative;
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 0.75rem;
      color: var(--police-light);
      opacity: 0.8;
    }

    .stat-item:nth-child(1) .stat-icon {
      color: var(--police-blue);
    }
    .stat-item:nth-child(2) .stat-icon {
      color: var(--police-accent);
    }
    .stat-item:nth-child(3) .stat-icon {
      color: var(--police-success);
    }
    .stat-item:nth-child(4) .stat-icon {
      color: var(--police-warning);
    }

    .chart-container {
      flex: 1;
      min-height: 320px;
      width: 100%;
      position: relative;
      padding: 1.5rem 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .chart-placeholder {
      padding: 2rem;
      text-align: center;
      color: #999;
      font-size: 1.1rem;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      border-radius: var(--radius-sm);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .data-table th, .data-table td {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    .data-table th {
      background-color: rgba(26, 62, 114, 0.08);
      font-weight: 600;
      color: var(--police-dark);
      position: relative;
    }

    .data-table th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background: rgba(26, 62, 114, 0.2);
    }

    .data-table tbody tr {
      transition: var(--transition-fast);
    }

    .data-table tbody tr:hover {
      background-color: rgba(0,0,0,.02);
    }

    .module-row {
      cursor: pointer;
    }

    .module-row:hover {
      background-color: rgba(26, 62, 114, 0.05) !important;
    }

    .module-name {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
    }

    .module-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: var(--police-blue);
      border-radius: 50%;
      font-size: 0.85rem;
    }

    .visit-bar {
      height: 8px;
      background: linear-gradient(90deg, var(--police-light), rgba(162, 192, 229, 0.5));
      border-radius: 4px;
      margin-top: 6px;
      max-width: 100%;
      position: relative;
      overflow: hidden;
    }

    .visit-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 30%;
      height: 100%;
      background: rgba(255,255,255,0.3);
      animation: barLight 2s ease-in-out infinite;
    }

    @keyframes barLight {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(400%);
      }
    }

    .footer {
      background: var(--police-dark);
      color: rgba(255,255,255,.8);
      padding: 1.5rem 2rem;
      text-align: center;
      font-size: .9rem;
      margin-top: auto;
      position: relative;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--police-blue), var(--police-accent), var(--police-blue));
    }

    .date-filter {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 1rem;
      margin-bottom: 1.5rem;
      background: #fff;
      padding: 1rem;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
    }

    .date-filter select {
      padding: 0.6rem 1rem;
      border-radius: var(--radius-sm);
      border: 1px solid #ddd;
      background: white;
      font-size: 0.95rem;
      transition: var(--transition-fast);
      cursor: pointer;
    }

    .date-filter select:hover {
      border-color: var(--police-blue);
    }

    .date-filter select:focus {
      outline: none;
      border-color: var(--police-blue);
      box-shadow: 0 0 0 3px rgba(26, 62, 114, 0.1);
    }

    /* 动画 */
    .fade-in {
      opacity: 0;
      animation: fadeIn .45s ease-out forwards;
    }  
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      from {
        transform: scale(1);
        opacity: 1;
      }
      to {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    /* 图表画布样式 */
    canvas {
      max-width: 100%;
      height: auto !important;
      padding: 1rem;
    }

    /* 响应式布局 */
    @media (max-width: 992px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }
      .title-text {
        font-size: 1.2rem;
      }
      .subtitle {
        display: none;
      }
      .main-content {
        padding: 1rem;
      }
      .summary-stats {
        grid-template-columns: 1fr;
      }
      .stats-title {
        font-size: 1.6rem;
      }
    }

    /* 加载动画 */
    #stats-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(26, 62, 114, 0.1);
      border-top-color: var(--police-blue);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* 提示框 */
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: var(--transition-fast);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* 标签 */
    .tag {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 4px;
      color: #fff;
      margin-left: 0.5rem;
    }

    .tag-active {
      background: var(--police-success);
    }

    .tag-inactive {
      background: var(--police-accent);
    }

    /* 使用时长显示 */
    .time-spent {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .time-icon {
      color: var(--police-info);
    }
  </style>
<script src="tracking.js"></script>
</head>
<body>
  <!-- 顶栏 -->
  <header class="header">
    <div class="logo"><i class="fa-solid fa-shield-halved logo-icon"></i>
      <div><div class="title-text">经济犯罪侦查工作平台</div><div class="subtitle">Economic Crime Investigation Platform</div></div>
    </div>
    <div class="header-right">
      <a href="index.html" class="back-link" title="返回首页"><i class="fa-solid fa-home"></i></a>
      <span id="current-date"></span>
    </div>
  </header>

  <!-- 主体 -->
  <main class="main-content">
    <div class="stats-header fade-in">
      <h1 class="stats-title">系统使用统计</h1>
      <p class="stats-subtitle">平台各模块使用情况与访问统计分析</p>
    </div>

    <div class="date-filter fade-in">
      <label for="time-range">时间范围:</label>
      <select id="time-range">
        <option value="7">最近7天</option>
        <option value="30" selected>最近30天</option>
        <option value="90">最近90天</option>
        <option value="365">最近365天</option>
      </select>
    </div>

    <div class="summary-stats fade-in">
      <div class="stat-item">
        <i class="fa-solid fa-eye stat-icon"></i>
        <div class="stat-value" id="total-visits">0</div>
        <div class="stat-label">总访问次数</div>
      </div>
      <div class="stat-item">
        <i class="fa-solid fa-clock stat-icon"></i>
        <div class="stat-value" id="active-sessions">0</div>
        <div class="stat-label">活跃会话数</div>
      </div>
      <div class="stat-item">
        <i class="fa-solid fa-calendar-check stat-icon"></i>
        <div class="stat-value" id="active-days">0</div>
        <div class="stat-label">使用天数</div>
      </div>
      <div class="stat-item">
        <i class="fa-solid fa-hourglass-half stat-icon"></i>
        <div class="stat-value" id="avg-time-spent">0</div>
        <div class="stat-label">平均使用时长 (分钟)</div>
      </div>
    </div>

    <div class="stats-container">
      <!-- 模块使用频率卡片 -->
      <div class="stats-card fade-in">
        <div class="card-header">
          <span>模块使用频率</span>
          <i class="fa-solid fa-chart-pie"></i>
        </div>
        <div class="card-body">
          <div class="chart-container" id="modules-chart-container">
            <canvas id="modules-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- 使用趋势卡片 -->
      <div class="stats-card fade-in">
        <div class="card-header">
          <span>使用趋势分析</span>
          <i class="fa-solid fa-chart-line"></i>
        </div>
        <div class="card-body">
          <div class="chart-container" id="trend-chart-container">
            <canvas id="trend-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="stats-container">
      <!-- 使用时段分布卡片 -->
      <div class="stats-card fade-in">
        <div class="card-header">
          <span>使用时段分布</span>
          <i class="fa-solid fa-clock-rotate-left"></i>
        </div>
        <div class="card-body">
          <div class="chart-container" id="time-distribution-container">
            <canvas id="time-distribution-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- 模块停留时间卡片 -->
      <div class="stats-card fade-in">
        <div class="card-header">
          <span>模块停留时间</span>
          <i class="fa-solid fa-hourglass-half"></i>
        </div>
        <div class="card-body">
          <div class="chart-container" id="time-spent-container">
            <canvas id="time-spent-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- 模块数据表格 -->
    <div class="stats-card fade-in">
      <div class="card-header">
        <span>详细使用数据</span>
        <i class="fa-solid fa-table-list"></i>
      </div>
      <div class="card-body">
        <table class="data-table" id="modules-table">
          <thead>
            <tr>
              <th>模块名称</th>
              <th>访问次数</th>
              <th>平均停留时间</th>
              <th>活跃度</th>
              <th>最后访问时间</th>
              <th>使用占比</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- 数据将通过JS动态填充 -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="footer">© 2025 贵阳市公安局经侦支队 | 技术支持：何国钦工作室</footer>

  <div id="tooltip" class="tooltip"></div>

  <!-- Chart.js 脚本 -->
  <script>
    // 模拟Chart.js功能，因为是离线环境
    class Chart {
      constructor(ctx, config) {
        this.ctx = ctx;
        this.config = config;
        this.render();
      }

      render() {
        const canvas = this.ctx.canvas;
        const ctx = this.ctx;
        
        // 清除画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 根据图表类型绘制
        if (this.config.type === 'pie' || this.config.type === 'doughnut') {
          this.renderPieChart();
        } else if (this.config.type === 'bar') {
          this.renderBarChart();
        } else if (this.config.type === 'line') {
          this.renderLineChart();
        } else if (this.config.type === 'horizontalBar') {
          this.renderHorizontalBarChart();
        }
      }

      renderPieChart() {
        const canvas = this.ctx.canvas;
        const ctx = this.ctx;
        const data = this.config.data;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) * 0.8;
        
        let startAngle = 0;
        const total = data.datasets[0].data.reduce((sum, value) => sum + value, 0);
        
        // 存储扇区信息，用于交互
        if (!canvas._sectors) {
          canvas._sectors = [];
        } else {
          canvas._sectors = [];
        }
        
        // 绘制阴影
        ctx.shadowColor = 'rgba(0,0,0,0.2)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        // 绘制饼图扇区
        data.datasets[0].data.forEach((value, i) => {
          const sliceAngle = 2 * Math.PI * value / total;
          
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
          ctx.closePath();
          
          ctx.fillStyle = data.datasets[0].backgroundColor[i];
          ctx.fill();
          
          // 存储扇区信息
          canvas._sectors.push({
            startAngle: startAngle,
            endAngle: startAngle + sliceAngle,
            color: data.datasets[0].backgroundColor[i],
            value: value,
            percentage: Math.round(value / total * 100),
            label: data.labels[i]
          });
          
          // 添加标签 - 只显示百分比
          const labelAngle = startAngle + sliceAngle / 2;
          const labelRadius = radius * 0.7;
          const labelX = centerX + Math.cos(labelAngle) * labelRadius;
          const labelY = centerY + Math.sin(labelAngle) * labelRadius;
          
          ctx.shadowColor = 'transparent';
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 14px Microsoft YaHei';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          // 只添加百分比，不显示模块名称
          const percentage = Math.round(value / total * 100);
          if (percentage > 3) { // 降低显示阈值，让更多模块显示标签
            ctx.fillText(`${percentage}%`, labelX, labelY);
          }
          
          startAngle += sliceAngle;
        });
        
        // 删除图例渲染代码
        
        // 如果是环形图，绘制中心空白
        if (this.config.type === 'doughnut') {
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius * 0.6, 0, 2 * Math.PI);
          ctx.fillStyle = '#fff';
          ctx.shadowColor = 'rgba(0,0,0,0.1)';
          ctx.shadowBlur = 5;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          ctx.fill();
          
          // 中心显示总数
          ctx.fillStyle = '#1a3e72';
          ctx.font = 'bold 24px Microsoft YaHei';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.shadowColor = 'transparent';
          ctx.fillText(total, centerX, centerY - 10);
          
          ctx.font = '14px Microsoft YaHei';
          ctx.fillStyle = '#666';
          ctx.fillText('总访问量', centerX, centerY + 20);
        }
        
        // 添加鼠标移动监听（如果尚未添加）
        if (!canvas._hasMouseHandler) {
          canvas._hasMouseHandler = true;
          
          canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // 获取上下文
            const ctx = canvas.getContext('2d');
            
            // 计算鼠标到中心的距离和角度
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            let angle = Math.atan2(dy, dx);
            if (angle < 0) angle += 2 * Math.PI; // 转换为[0, 2π]范围
            
            // 检查是否在环形区域内
            const isRingArea = (this.config && this.config.type === 'doughnut') ? 
                (distance < radius && distance > radius * 0.6) : 
                (distance < radius);
            
            let hoveredSector = null;
            
            // 如果在环形区域内，查找所在扇区
            if (isRingArea && canvas._sectors) {
              hoveredSector = canvas._sectors.find(sector => 
                angle >= sector.startAngle && angle <= sector.endAngle
              );
            }
            
            // 显示或隐藏提示
            if (hoveredSector) {
              // 显示提示
              showTooltip(e, `${hoveredSector.label}: ${hoveredSector.value}次访问 (${hoveredSector.percentage}%)`);
              
              // 重绘图表以突出显示悬停的扇区
              this._redrawWithHighlight(hoveredSector);
            } else {
              // 隐藏提示
              hideTooltip();
              
              // 恢复正常图表
              if (canvas._needsRestore) {
                this._restoreChart();
                canvas._needsRestore = false;
              }
            }
          }.bind(this));
          
          // 鼠标离开时恢复正常图表
          canvas.addEventListener('mouseout', function() {
            hideTooltip();
            if (canvas._needsRestore) {
              this._restoreChart();
              canvas._needsRestore = false;
            }
          }.bind(this));
        }
      }
      
      // 重绘图表以突出显示扇区
      _redrawWithHighlight(sector) {
        const canvas = this.ctx.canvas;
        const ctx = this.ctx;
        
        // 标记需要恢复
        canvas._needsRestore = true;
        
        // 存储当前状态
        canvas._originalConfig = JSON.parse(JSON.stringify(this.config));
        
        // 重绘所有扇区，使悬停的扇区突出显示
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) * 0.8;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 绘制阴影
        ctx.shadowColor = 'rgba(0,0,0,0.2)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        // 绘制所有扇区
        canvas._sectors.forEach(s => {
          const isHighlighted = s === sector;
          
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          
          // 如果是高亮扇区，稍微向外移动
          const sectorRadius = isHighlighted ? radius * 1.05 : radius;
          ctx.arc(centerX, centerY, sectorRadius, s.startAngle, s.endAngle);
          ctx.closePath();
          
          // 高亮扇区使用更亮的颜色
          if (isHighlighted) {
            ctx.fillStyle = this.lightenColor(s.color, 15);
            // 增加阴影效果
            ctx.shadowColor = 'rgba(0,0,0,0.4)';
            ctx.shadowBlur = 15;
          } else {
            // 非高亮扇区略微变暗
            ctx.fillStyle = this.darkenColor(s.color, 10);
            ctx.shadowColor = 'rgba(0,0,0,0.1)';
            ctx.shadowBlur = 5;
          }
          
          ctx.fill();
          
          // 添加标签
          const labelAngle = (s.startAngle + s.endAngle) / 2;
          const labelRadius = isHighlighted ? sectorRadius * 0.7 : radius * 0.7;
          const labelX = centerX + Math.cos(labelAngle) * labelRadius;
          const labelY = centerY + Math.sin(labelAngle) * labelRadius;
          
          ctx.shadowColor = 'transparent';
          ctx.fillStyle = '#fff';
          ctx.font = isHighlighted ? 'bold 16px Microsoft YaHei' : 'bold 14px Microsoft YaHei';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          if (s.percentage > 3) {
            ctx.fillText(`${s.percentage}%`, labelX, labelY);
          }
        });
        
        // 如果是环形图，重绘中心空白
        if (this.config.type === 'doughnut') {
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius * 0.6, 0, 2 * Math.PI);
          ctx.fillStyle = '#fff';
          ctx.shadowColor = 'rgba(0,0,0,0.1)';
          ctx.shadowBlur = 5;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          ctx.fill();
          
          // 中心显示总数
          const total = canvas._sectors.reduce((sum, s) => sum + s.value, 0);
          
          ctx.fillStyle = '#1a3e72';
          ctx.font = 'bold 24px Microsoft YaHei';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.shadowColor = 'transparent';
          ctx.fillText(total, centerX, centerY - 10);
          
          ctx.font = '14px Microsoft YaHei';
          ctx.fillStyle = '#666';
          ctx.fillText('总访问量', centerX, centerY + 20);
          
          // 如果有高亮扇区，显示其名称
          if (sector) {
            ctx.font = 'bold 12px Microsoft YaHei';
            ctx.fillStyle = '#333';
            ctx.fillText(sector.label, centerX, centerY + 45);
          }
        }
      }
      
      // 恢复正常图表
      _restoreChart() {
        const canvas = this.ctx.canvas;
        
        if (canvas._originalConfig) {
          this.config = canvas._originalConfig;
          this.render();
        }
      }
      
      // 辅助函数：颜色处理
      hexToRgba(hex, alpha) {
        let r = 0, g = 0, b = 0;
        
        // 3位十六进制
        if (hex.length === 4) {
          r = parseInt(hex[1] + hex[1], 16);
          g = parseInt(hex[2] + hex[2], 16);
          b = parseInt(hex[3] + hex[3], 16);
        } 
        // 6位十六进制
        else if (hex.length === 7) {
          r = parseInt(hex.substr(1, 2), 16);
          g = parseInt(hex.substr(3, 2), 16);
          b = parseInt(hex.substr(5, 2), 16);
        }
        
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      
      lightenColor(color, percent) {
        const num = parseInt(color.substr(1), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        
        return '#' + (
          0x1000000 + 
          (R < 255 ? (R < 0 ? 0 : R) : 255) * 0x10000 + 
          (G < 255 ? (G < 0 ? 0 : G) : 255) * 0x100 + 
          (B < 255 ? (B < 0 ? 0 : B) : 255)
        ).toString(16).slice(1);
      }
      
      darkenColor(color, percent) {
        const num = parseInt(color.substr(1), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) - amt;
        const G = (num >> 8 & 0x00FF) - amt;
        const B = (num & 0x0000FF) - amt;
        
        return '#' + (
          0x1000000 + 
          (R > 0 ? (R > 255 ? 255 : R) : 0) * 0x10000 + 
          (G > 0 ? (G > 255 ? 255 : G) : 0) * 0x100 + 
          (B > 0 ? (B > 255 ? 255 : B) : 0)
        ).toString(16).slice(1);
      }

      renderBarChart() {
        const canvas = this.ctx.canvas;
        const ctx = this.ctx;
        const data = this.config.data;
        
        const chartWidth = canvas.width * 0.85;
        const chartHeight = canvas.height * 0.7;
        const chartLeft = canvas.width * 0.1;
        const chartBottom = canvas.height * 0.85;
        const chartTop = canvas.height * 0.15;
        
        // 计算最大值
        const allData = data.datasets.flatMap(dataset => dataset.data);
        const maxValue = Math.max(...allData) * 1.1 || 1;
        
        // 绘制网格线和Y轴
        const gridCount = 5;
        for (let i = 0; i <= gridCount; i++) {
          const y = chartBottom - (chartHeight / gridCount * i);
          
          ctx.beginPath();
          ctx.moveTo(chartLeft, y);
          ctx.lineTo(chartLeft + chartWidth, y);
          ctx.strokeStyle = i === 0 ? '#ccc' : '#eee';
          ctx.lineWidth = i === 0 ? 1 : 0.5;
          ctx.stroke();
          
          // 标记Y轴刻度
          if (i > 0) {
            ctx.fillStyle = '#666';
            ctx.font = '12px Microsoft YaHei';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(Math.round(maxValue / gridCount * i), chartLeft - 8, y);
          }
        }
        
        // 绘制X轴
        ctx.beginPath();
        ctx.moveTo(chartLeft, chartBottom);
        ctx.lineTo(chartLeft + chartWidth, chartBottom);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // 绘制柱状图
        const barCount = data.labels.length;
        const barWidth = chartWidth / barCount * 0.7;
        const spacing = chartWidth / barCount * 0.3;
        
        // 添加阴影
        ctx.shadowColor = 'rgba(0,0,0,0.1)';
        ctx.shadowBlur = 5;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        data.datasets.forEach((dataset, datasetIndex) => {
          dataset.data.forEach((value, i) => {
            const barHeight = (value / maxValue) * chartHeight;
            const barLeft = chartLeft + (barWidth + spacing) * i + (datasetIndex * (barWidth / data.datasets.length));
            const barWidthFinal = barWidth / data.datasets.length;
            
            // 创建渐变
            const gradient = ctx.createLinearGradient(barLeft, chartBottom, barLeft, chartBottom - barHeight);
            gradient.addColorStop(0, dataset.backgroundColor);
            gradient.addColorStop(1, dataset.hoverBackgroundColor || dataset.backgroundColor);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(barLeft, chartBottom - barHeight, barWidthFinal, barHeight);
            
            // 添加数值标签
            if (value > 0) {
              ctx.shadowColor = 'transparent';
              ctx.fillStyle = '#333';
              ctx.font = 'bold 12px Microsoft YaHei';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              ctx.fillText(value, barLeft + barWidthFinal/2, chartBottom - barHeight - 5);
            }
          });
        });
        
        // 添加X轴标签
        ctx.shadowColor = 'transparent';
        data.labels.forEach((label, i) => {
          const x = chartLeft + (barWidth + spacing) * i + barWidth/2;
          
          ctx.fillStyle = '#333';
          ctx.font = '12px Microsoft YaHei';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          ctx.fillText(label, x, chartBottom + 8);
        });
        
        // 绘制图例
        if (data.datasets.length > 1) {
          const legendY = chartTop - 15;
          const legendItemWidth = 120;
          
          data.datasets.forEach((dataset, i) => {
            const x = canvas.width / 2 - ((data.datasets.length * legendItemWidth) / 2) + (i * legendItemWidth) + 20;
            
            // 绘制颜色方块
            ctx.fillStyle = dataset.backgroundColor;
            ctx.fillRect(x, legendY, 16, 16);
            
            // 绘制标签
            ctx.fillStyle = '#333';
            ctx.font = '12px Microsoft YaHei';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(dataset.label, x + 24, legendY + 8);
          });
        }
      }

      renderHorizontalBarChart() {
        const canvas = this.ctx.canvas;
        const ctx = this.ctx;
        const data = this.config.data;
        
        const chartWidth = canvas.width * 0.75;
        const chartHeight = canvas.height * 0.8;
        const chartLeft = canvas.width * 0.2;
        const chartBottom = canvas.height * 0.9;
        const chartTop = canvas.height * 0.1;
        
        // 计算最大值
        const maxValue = Math.max(...data.datasets[0].data) * 1.1 || 1;
        
        // 绘制背景网格线
        const gridCount = 5;
        for (let i = 0; i <= gridCount; i++) {
          const x = chartLeft + (chartWidth / gridCount * i);
          
          ctx.beginPath();
          ctx.moveTo(x, chartTop);
          ctx.lineTo(x, chartBottom);
          ctx.strokeStyle = i === 0 ? '#ccc' : '#eee';
          ctx.lineWidth = i === 0 ? 1 : 0.5;
          ctx.stroke();
          
          // 添加X轴刻度
          if (i > 0) {
            ctx.fillStyle = '#666';
            ctx.font = '12px Microsoft YaHei';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(Math.round(maxValue / gridCount * i), x, chartBottom + 5);
          }
        }
        
        // 绘制Y轴
        ctx.beginPath();
        ctx.moveTo(chartLeft, chartTop);
        ctx.lineTo(chartLeft, chartBottom);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // 绘制水平条形图
        const barCount = data.labels.length;
        const barHeight = chartHeight / barCount * 0.7;
        const spacing = chartHeight / barCount * 0.3;
        
        // 设置阴影
        ctx.shadowColor = 'rgba(0,0,0,0.1)';
        ctx.shadowBlur = 5;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        data.datasets[0].data.forEach((value, i) => {
          const barWidth = (value / maxValue) * chartWidth;
          const barTop = chartTop + (barHeight + spacing) * i;
          
          // 创建渐变
          const gradient = ctx.createLinearGradient(chartLeft, barTop, chartLeft + barWidth, barTop);
          const color = Array.isArray(data.datasets[0].backgroundColor) ? 
                        data.datasets[0].backgroundColor[i] : 
                        data.datasets[0].backgroundColor;
                        
          gradient.addColorStop(0, color);
          gradient.addColorStop(1, this.lightenColor(color, 30));
          
          ctx.fillStyle = gradient;
          ctx.fillRect(chartLeft, barTop, barWidth, barHeight);
          
          // 添加标签和值
          ctx.shadowColor = 'transparent';
          
          // 模块名称标签
          ctx.fillStyle = '#333';
          ctx.font = '13px Microsoft YaHei';
          ctx.textAlign = 'right';
          ctx.textBaseline = 'middle';
          const labelText = data.labels[i];
          ctx.fillText(labelText, chartLeft - 10, barTop + barHeight/2);
          
          // 数值标签
          if (value > 0) {
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Microsoft YaHei';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            
            const valueText = this.config.options && this.config.options.timeFormat ? 
                              this.formatTime(value) : value.toString();
                              
            // 只有当条足够长时才在条内显示值
            if (barWidth > 50) {
              ctx.fillText(valueText, chartLeft + barWidth - 40, barTop + barHeight/2);
            } else {
              ctx.fillStyle = '#333';
              ctx.fillText(valueText, chartLeft + barWidth + 5, barTop + barHeight/2);
            }
          }
        });
      }

      renderLineChart() {
        const canvas = this.ctx.canvas;
        const ctx = this.ctx;
        const data = this.config.data;
        
        const chartWidth = canvas.width * 0.85;
        const chartHeight = canvas.height * 0.7;
        const chartLeft = canvas.width * 0.1;
        const chartBottom = canvas.height * 0.85;
        const chartTop = canvas.height * 0.15;
        
        // 计算最大值
        const allData = data.datasets.flatMap(dataset => dataset.data);
        const maxValue = Math.max(...allData) * 1.1 || 1;
        
        // 绘制网格线和Y轴刻度
        const gridCount = 5;
        for (let i = 0; i <= gridCount; i++) {
          const y = chartBottom - (chartHeight / gridCount * i);
          
          ctx.beginPath();
          ctx.moveTo(chartLeft, y);
          ctx.lineTo(chartLeft + chartWidth, y);
          ctx.strokeStyle = i === 0 ? '#ccc' : '#eee';
          ctx.lineWidth = i === 0 ? 1 : 0.5;
          ctx.stroke();
          
          // Y轴刻度
          if (i > 0) {
            ctx.fillStyle = '#666';
            ctx.font = '12px Microsoft YaHei';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(Math.round(maxValue / gridCount * i), chartLeft - 8, y);
          }
        }
        
        // X轴
        ctx.beginPath();
        ctx.moveTo(chartLeft, chartBottom);
        ctx.lineTo(chartLeft + chartWidth, chartBottom);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // 绘制X轴标签和垂直参考线
        const pointCount = data.labels.length;
        const pointSpacing = chartWidth / (pointCount - 1);
        
        data.labels.forEach((label, i) => {
          const x = chartLeft + pointSpacing * i;
          
          // 垂直参考线
          if (i > 0 && i < pointCount - 1) {
            ctx.beginPath();
            ctx.moveTo(x, chartTop);
            ctx.lineTo(x, chartBottom);
            ctx.strokeStyle = '#f5f5f5';
            ctx.stroke();
          }
          
          // X轴标签
          ctx.fillStyle = '#333';
          ctx.font = '12px Microsoft YaHei';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          ctx.fillText(label, x, chartBottom + 8);
        });
        
        // 绘制数据线和区域
        data.datasets.forEach((dataset, datasetIndex) => {
          const gradient = ctx.createLinearGradient(0, chartTop, 0, chartBottom);
          gradient.addColorStop(0, this.hexToRgba(dataset.borderColor, 0.3));
          gradient.addColorStop(1, this.hexToRgba(dataset.borderColor, 0.05));
          
          // 绘制区域填充
          ctx.beginPath();
          
          dataset.data.forEach((value, i) => {
            const x = chartLeft + pointSpacing * i;
            const y = chartBottom - (value / maxValue) * chartHeight;
            
            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          
          // 完成区域填充路径
          ctx.lineTo(chartLeft + pointSpacing * (pointCount - 1), chartBottom);
          ctx.lineTo(chartLeft, chartBottom);
          ctx.closePath();
          
          ctx.fillStyle = gradient;
          ctx.fill();
          
          // 绘制线条
          ctx.beginPath();
          
          dataset.data.forEach((value, i) => {
            const x = chartLeft + pointSpacing * i;
            const y = chartBottom - (value / maxValue) * chartHeight;
            
            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          
          ctx.strokeStyle = dataset.borderColor;
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // 绘制数据点
          dataset.data.forEach((value, i) => {
            const x = chartLeft + pointSpacing * i;
            const y = chartBottom - (value / maxValue) * chartHeight;
            
            // 外圆
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fillStyle = '#fff';
            ctx.fill();
            ctx.strokeStyle = dataset.borderColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 内圆
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, 2 * Math.PI);
            ctx.fillStyle = dataset.borderColor;
            ctx.fill();
          });
        });
        
        // 绘制图例
        if (data.datasets.length > 1) {
          const legendY = chartTop - 15;
          const legendItemWidth = 120;
          
          data.datasets.forEach((dataset, i) => {
            const x = canvas.width / 2 - ((data.datasets.length * legendItemWidth) / 2) + (i * legendItemWidth) + 20;
            
            // 绘制线条
            ctx.beginPath();
            ctx.moveTo(x, legendY + 8);
            ctx.lineTo(x + 20, legendY + 8);
            ctx.strokeStyle = dataset.borderColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制点
            ctx.beginPath();
            ctx.arc(x + 10, legendY + 8, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#fff';
            ctx.fill();
            ctx.strokeStyle = dataset.borderColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制标签
            ctx.fillStyle = '#333';
            ctx.font = '12px Microsoft YaHei';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(dataset.label, x + 24, legendY + 8);
          });
        }
      }
      
      // 辅助函数：颜色处理
      hexToRgba(hex, alpha) {
        let r = 0, g = 0, b = 0;
        
        // 3位十六进制
        if (hex.length === 4) {
          r = parseInt(hex[1] + hex[1], 16);
          g = parseInt(hex[2] + hex[2], 16);
          b = parseInt(hex[3] + hex[3], 16);
        } 
        // 6位十六进制
        else if (hex.length === 7) {
          r = parseInt(hex.substr(1, 2), 16);
          g = parseInt(hex.substr(3, 2), 16);
          b = parseInt(hex.substr(5, 2), 16);
        }
        
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      
      lightenColor(color, percent) {
        const num = parseInt(color.substr(1), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        
        return '#' + (
          0x1000000 + 
          (R < 255 ? (R < 0 ? 0 : R) : 255) * 0x10000 + 
          (G < 255 ? (G < 0 ? 0 : G) : 255) * 0x100 + 
          (B < 255 ? (B < 0 ? 0 : B) : 255)
        ).toString(16).slice(1);
      }
      
      // 时间格式化
      formatTime(minutes) {
        if (minutes < 60) {
          return `${Math.round(minutes)}分钟`;
        } else {
          const hours = Math.floor(minutes / 60);
          const mins = Math.round(minutes % 60);
          return `${hours}小时${mins > 0 ? mins + '分钟' : ''}`;
        }
      }

      // 获取模块名称的简称，用于饼图标签
      getShortLabel(label) {
        // 如果名称太长，截取前两个字符
        if (label && label.length > 4) {
          return label.substring(0, 2);
        }
        return label;
      }
    }

    // 当前日期显示
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN',{year:'numeric',month:'long',day:'numeric',weekday:'long'});

    // 模块列表及图标映射
    const moduleIcons = {
      'general-ai': 'fa-robot',
      'general-case': 'fa-magnifying-glass-chart',
      'doc-writing': 'fa-pen-fancy',
      'finance-case': 'fa-landmark',
      'securities-case': 'fa-chart-simple',
      'tax-case': 'fa-receipt',
      'trade-case': 'fa-store',
      'money-laundering': 'fa-money-bill-transfer',
      'evidence-analysis': 'fa-scale-balanced',
      'case-guide': 'fa-compass',
      'data-analysis': 'fa-chart-pie',
      'person-info-analysis': 'fa-user',
      'police-data-analysis': 'fa-chart-line'
    };

    const moduleNames = {
      'general-ai': '通用AI助手',
      'general-case': '通用案件研判',
      'doc-writing': '公文写作助手',
      'finance-case': '金融领域',
      'securities-case': '证券领域',
      'tax-case': '涉税领域',
      'trade-case': '商贸领域',
      'money-laundering': '反洗钱领域',
      'evidence-analysis': '金析为证',
      'case-guide': '办案指引',
      'data-analysis': '数据分析',
      'person-info-analysis': '人员基础信息分析',
      'police-data-analysis': '警情数据分析'
    };

    // 模块颜色映射
    const moduleColors = {
      'general-ai': '#1a3e72',
      'general-case': '#e74c3c',
      'doc-writing': '#2ecc71',
      'finance-case': '#f39c12',
      'securities-case': '#9b59b6',
      'tax-case': '#3498db',
      'trade-case': '#1abc9c',
      'money-laundering': '#d35400',
      'evidence-analysis': '#27ae60',
      'case-guide': '#8e44ad',
      'data-analysis': '#e67e22',
      'person-info-analysis': '#16a085',
      'police-data-analysis': '#c0392b'
    };

    // 获取服务器端真实访问统计数据
    async function fetchStatsData(timeRange) {
      try {
        // 显示加载状态
        showLoading();
        
        // 获取统计数据
        console.log(`正在从API获取数据，时间范围: ${timeRange}天`);
        
        // 使用完整URL，包含主机名
        const apiUrl = `http://${window.location.hostname}:22223/api/stats?days=${timeRange || 30}`;
        console.log(`请求API: ${apiUrl}`);
        
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          cache: 'no-store' // 不使用缓存，每次请求最新数据
        });
        
        if (!response.ok) {
          throw new Error(`获取数据失败: ${response.status} ${response.statusText}`);
        }
        
        // 解析服务器返回的数据
        const data = await response.json();
        console.log('API返回数据:', data);
        
        // 检查和修正数据类型
        Object.keys(data).forEach(moduleId => {
          const moduleData = data[moduleId];
          
          // 确保avgTimeSpent是数值类型
          if (moduleData.avgTimeSpent !== undefined && moduleData.avgTimeSpent !== null) {
            moduleData.avgTimeSpent = parseFloat(moduleData.avgTimeSpent);
            console.log(`修正 ${moduleId} 的 avgTimeSpent: ${moduleData.avgTimeSpent}`);
          }
          
          // 如果avgTimeSpent无效但有visits和timeSpent，则计算平均值
          if ((!moduleData.avgTimeSpent || isNaN(moduleData.avgTimeSpent)) && 
              moduleData.visits > 0 && moduleData.timeSpent > 0) {
            moduleData.avgTimeSpent = moduleData.timeSpent / moduleData.visits;
            console.log(`计算 ${moduleId} 的 avgTimeSpent: ${moduleData.avgTimeSpent}`);
          }
        });
        
        // 检查general-case模块的avgTimeSpent值
        if (data['general-case']) {
          console.log('general-case模块数据:', data['general-case']);
          console.log('avgTimeSpent值:', data['general-case'].avgTimeSpent);
          console.log('timeSpent值:', data['general-case'].timeSpent);
          console.log('avgTimeSpent类型:', typeof data['general-case'].avgTimeSpent);
        }
        
        // 隐藏加载状态
        hideLoading();
        
        return data;
      } catch (error) {
        console.error('获取统计数据失败:', error);
        hideLoading();
        
        // 尝试使用XMLHttpRequest作为备用方案
        try {
          const data = await fetchWithXHR(timeRange);
          return data;
        } catch (xhrError) {
          console.error('XMLHttpRequest获取数据也失败:', xhrError);
          
          // 如果无法获取服务器数据，显示本地存储的数据或生成演示数据
          alertMessage('无法从服务器获取最新数据，将显示本地缓存数据');
          return getFallbackData();
        }
      }
    }
    
    // 使用XMLHttpRequest获取数据作为备用方案
    function fetchWithXHR(timeRange) {
      return new Promise((resolve, reject) => {
        const apiUrl = `http://${window.location.hostname}:22223/api/stats?days=${timeRange || 30}`;
        console.log(`使用XMLHttpRequest请求: ${apiUrl}`);
        
        const xhr = new XMLHttpRequest();
        xhr.open('GET', apiUrl, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const data = JSON.parse(xhr.responseText);
              console.log('XHR获取数据成功:', data);
              resolve(data);
            } catch (e) {
              reject(new Error(`解析XHR响应失败: ${e.message}`));
            }
          } else {
            reject(new Error(`XHR请求失败: ${xhr.status}`));
          }
        };
        
        xhr.onerror = function() {
          reject(new Error('XHR网络错误'));
        };
        
        xhr.send();
      });
    }
    
    // 显示加载状态
    function showLoading() {
      if(document.getElementById('stats-loader')) return;
      
      const loader = document.createElement('div');
      loader.id = 'stats-loader';
      loader.innerHTML = '<div class="spinner"></div>';
      document.body.appendChild(loader);
    }
    
    // 隐藏加载状态
    function hideLoading() {
      const loader = document.getElementById('stats-loader');
      if (loader) {
        loader.remove();
      }
    }
    
    // 显示通知消息
    function alertMessage(message) {
      const alert = document.createElement('div');
      alert.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:rgba(231,76,60,0.9);color:#fff;padding:12px 24px;border-radius:4px;z-index:9999;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
      alert.textContent = message;
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transition = 'opacity 0.5s ease';
        setTimeout(() => alert.remove(), 500);
      }, 3000);
    }
    
    // 备用数据（从localStorage获取或生成演示数据）
    function getFallbackData() {
      // 从localStorage获取统计数据
      let moduleStats = localStorage.getItem('moduleVisitStats');
      
      if (moduleStats) {
        try {
          return JSON.parse(moduleStats);
        } catch (e) {
          console.error('解析统计数据出错:', e);
          return generateDummyData();
        }
      } else {
        // 如果没有数据，生成演示数据
        return generateDummyData();
      }
    }

    // 生成演示数据（实际应用中应从服务器获取）
    function generateDummyData() {
      const moduleIds = Object.keys(moduleNames);
      const stats = {};
      const today = new Date();
      
      // 生成基本访问数据
      moduleIds.forEach(moduleId => {
        const baseVisits = Math.floor(Math.random() * 100) + 20;
        const activeRate = Math.random() * 0.6 + 0.2;  // 20%-80%
        const avgTimeSpent = Math.floor(Math.random() * 25) + 5; // 平均停留时间5-30分钟
        
        stats[moduleId] = {
          visits: baseVisits,
          active: Math.floor(baseVisits * activeRate),
          timeSpent: avgTimeSpent * baseVisits, // 总停留时间
          avgTimeSpent: avgTimeSpent, // 平均停留时间
          lastVisit: new Date(today - Math.floor(Math.random() * 7 * 24 * 60 * 60 * 1000)).getTime(),
          dailyData: [],
          hourlyData: Array(24).fill().map((_, i) => ({
            hour: i,
            visits: Math.floor(Math.random() * 15) + (i >= 8 && i <= 18 ? 10 : 3) // 工作时间访问更多
          }))
        };
        
        // 生成每日数据（30天）
        for (let i = 29; i >= 0; i--) {
          const dayVisits = i === 0 ? baseVisits : Math.floor(Math.random() * (baseVisits/2)) + 5;
          const dayTimeSpent = Math.floor(dayVisits * avgTimeSpent * (0.8 + Math.random() * 0.4));
          
          stats[moduleId].dailyData.push({
            date: new Date(today - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            visits: dayVisits,
            timeSpent: dayTimeSpent
          });
        }
      });
      
      return stats;
    }

    // 格式化日期
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // 格式化时间（分钟转为可读时间）
    function formatTimeSpent(minutes) {
      // 确保minutes是数字
      minutes = parseFloat(minutes) || 0;
      
      // 调试输出
      console.log(`格式化时间: 原始值=${minutes}, 类型=${typeof minutes}`);
      
      if (minutes < 1) {
        return '不足1分钟';
      } else if (minutes < 60) {
        return `${Math.round(minutes)}分钟`;
      } else {
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return `${hours}小时${mins > 0 ? mins + '分钟' : ''}`;
      }
    }

    // 更新摘要统计数据
    function updateSummaryStats(stats) {
      let totalVisits = 0;
      let totalActive = 0;
      let totalTimeSpent = 0;
      const uniqueDays = new Set();
      
      Object.values(stats).forEach(moduleData => {
        totalVisits += moduleData.visits || 0;
        totalActive += moduleData.active || 0;
        totalTimeSpent += moduleData.timeSpent || 0;
        
        // 收集唯一日期（用于计算使用天数）
        if (moduleData.dailyData) {
          moduleData.dailyData.forEach(day => {
            if (day.visits > 0) {
              uniqueDays.add(day.date);
            }
          });
        }
      });
      
      const avgTimeSpent = totalVisits > 0 ? Math.round(totalTimeSpent / totalVisits) : 0;
      
      document.getElementById('total-visits').textContent = totalVisits;
      document.getElementById('active-sessions').textContent = totalActive;
      document.getElementById('active-days').textContent = uniqueDays.size;
      document.getElementById('avg-time-spent').textContent = avgTimeSpent;
    }

    // 更新模块使用频率图表
    function updateModulesChart(stats) {
      const ctx = document.getElementById('modules-chart').getContext('2d');
      const moduleIds = Object.keys(stats);
      
      // 按访问次数排序，获取前8个，并排除index、stats和chrome-installer
      const topModules = moduleIds
        .filter(id => !['index', 'stats', 'chrome-installer'].includes(id)) // 排除index、stats和chrome-installer
        .sort((a, b) => (stats[b].visits || 0) - (stats[a].visits || 0))
        .slice(0, 8);
      
      const data = {
        labels: topModules.map(id => moduleNames[id] || id),
        datasets: [{
          data: topModules.map(id => stats[id].visits || 0),
          backgroundColor: topModules.map(id => moduleColors[id] || '#1a3e72')
        }]
      };
      
      // 创建与交互式图表
      new Chart(ctx, {
        type: 'doughnut',
        data: data
      });
      
      // 添加工具提示样式增强
      const tooltip = document.getElementById('tooltip');
      tooltip.style.zIndex = '2000';
      tooltip.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
      tooltip.style.borderRadius = '6px';
      tooltip.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
      tooltip.style.transform = 'translateY(10px)';
    }

    // 更新使用趋势图表
    function updateTrendChart(stats) {
      const ctx = document.getElementById('trend-chart').getContext('2d');
      const moduleIds = Object.keys(stats);
      
      // 按访问次数排序，获取前3个模块，排除chrome-installer
      const topModules = moduleIds
        .filter(id => !['chrome-installer'].includes(id)) // 排除chrome-installer
        .sort((a, b) => (stats[b].visits || 0) - (stats[a].visits || 0))
        .slice(0, 3);
      
      // 收集日期标签（取前3个模块的第一个模块的日期）
      const dates = stats[topModules[0]]?.dailyData?.map(day => day.date.substring(5)) || [];
      
      // 准备数据集
      const datasets = topModules.map((moduleId) => {
        return {
          label: moduleNames[moduleId] || moduleId,
          data: stats[moduleId].dailyData.map(day => day.visits),
          borderColor: moduleColors[moduleId] || '#1a3e72',
          backgroundColor: moduleColors[moduleId] || '#1a3e72'
        };
      });
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: datasets
        }
      });
    }
    
    // 更新使用时段分布图表
    function updateTimeDistributionChart(stats) {
      const ctx = document.getElementById('time-distribution-chart').getContext('2d');
      const moduleIds = Object.keys(stats)
        .filter(id => !['index', 'stats', 'chrome-installer'].includes(id)); // 排除index、stats和chrome-installer
      
      // 合并所有模块的时段数据
      const hourlyData = Array(24).fill(0);
      
      moduleIds.forEach(moduleId => {
        if (stats[moduleId].hourlyData) {
          stats[moduleId].hourlyData.forEach(hour => {
            hourlyData[hour.hour] += hour.visits;
          });
        }
      });
      
      // 准备标签（小时）- 只显示部分小时标签，避免重叠
      const hourLabels = Array(24).fill().map((_, i) => {
        // 每3小时显示一个标签，其余为空字符串
        return i % 3 === 0 ? `${i}:00` : '';
      });
      
      const data = {
        labels: hourLabels,
        datasets: [{
          label: '访问量',
          data: hourlyData,
          backgroundColor: '#4a6fa5',
          hoverBackgroundColor: '#1a3e72'
        }]
      };
      
      new Chart(ctx, {
        type: 'bar',
        data: data
      });
    }
    
    // 更新模块停留时间图表
    function updateTimeSpentChart(stats) {
      const ctx = document.getElementById('time-spent-chart').getContext('2d');
      const moduleIds = Object.keys(stats);
      
      // 按平均停留时间排序，获取前8个模块，排除index、stats和chrome-installer
      const topModules = moduleIds
        .filter(id => !['index', 'stats', 'chrome-installer'].includes(id)) // 排除index、stats和chrome-installer
        .map(id => {
          // 确保avgTimeSpent是数值
          const moduleData = stats[id];
          let avgTimeSpent = 0;
          
          if (moduleData.avgTimeSpent !== undefined && moduleData.avgTimeSpent !== null) {
            avgTimeSpent = parseFloat(moduleData.avgTimeSpent);
          } else if (moduleData.visits > 0 && moduleData.timeSpent > 0) {
            avgTimeSpent = moduleData.timeSpent / moduleData.visits;
          }
          
          return { id, avgTimeSpent };
        })
        .sort((a, b) => b.avgTimeSpent - a.avgTimeSpent)
        .slice(0, 8)
        .map(item => item.id);
      
      console.log('模块停留时间排序后:', topModules.map(id => ({ 
        id, 
        name: moduleNames[id], 
        avgTimeSpent: stats[id].avgTimeSpent 
      })));
      
      const data = {
        labels: topModules.map(id => moduleNames[id] || id),
        datasets: [{
          data: topModules.map(id => {
            // 确保使用处理后的avgTimeSpent值
            const moduleData = stats[id];
            let avgTimeSpent = 0;
            
            if (moduleData.avgTimeSpent !== undefined && moduleData.avgTimeSpent !== null) {
              avgTimeSpent = parseFloat(moduleData.avgTimeSpent);
              console.log(`${id} 的 avgTimeSpent 值: ${moduleData.avgTimeSpent}, 转换后: ${avgTimeSpent}`);
            } else if (moduleData.visits > 0 && moduleData.timeSpent > 0) {
              avgTimeSpent = moduleData.timeSpent / moduleData.visits;
              console.log(`${id} 计算 avgTimeSpent: ${moduleData.timeSpent} / ${moduleData.visits} = ${avgTimeSpent}`);
            }
            
            return avgTimeSpent;
          }),
          backgroundColor: topModules.map(id => moduleColors[id] || '#1a3e72')
        }]
      };
      
      new Chart(ctx, {
        type: 'horizontalBar',
        data: data,
        options: {
          timeFormat: true
        }
      });
    }

    // 更新模块数据表格
    function updateModulesTable(stats) {
      const tableBody = document.getElementById('table-body');
      tableBody.innerHTML = '';
      
      const moduleIds = Object.keys(stats)
        .filter(id => !['index', 'stats', 'chrome-installer'].includes(id)); // 排除index、stats和chrome-installer
      
      const totalVisits = moduleIds.reduce((sum, id) => sum + (stats[id].visits || 0), 0);
      
      // 按访问次数排序
      moduleIds.sort((a, b) => (stats[b].visits || 0) - (stats[a].visits || 0));
      
      moduleIds.forEach(moduleId => {
        const moduleData = stats[moduleId];
        
        // 确保avgTimeSpent是数字，避免显示"不足1分钟"的问题
        let avgTimeSpent = 0;
        
        // 检查avgTimeSpent是否存在且为有效数值
        if (moduleData.avgTimeSpent !== undefined && moduleData.avgTimeSpent !== null) {
          avgTimeSpent = parseFloat(moduleData.avgTimeSpent);
          console.log(`${moduleId} 的 avgTimeSpent:`, moduleData.avgTimeSpent, '转换后:', avgTimeSpent);
        } else if (moduleData.visits > 0 && moduleData.timeSpent > 0) {
          // 如果没有avgTimeSpent但有visits和timeSpent，则计算平均值
          avgTimeSpent = moduleData.timeSpent / moduleData.visits;
          console.log(`${moduleId} 计算 avgTimeSpent:`, avgTimeSpent);
        }
        
        const row = document.createElement('tr');
        row.className = 'module-row';
        
        // 添加鼠标悬停提示功能
        row.addEventListener('mouseover', function(e) {
          showTooltip(e, `${moduleNames[moduleId] || moduleId} - 总停留时间: ${formatTimeSpent(moduleData.timeSpent || 0)}`);
        });
        
        row.addEventListener('mouseout', hideTooltip);
        
        // 访问占比
        const visitPercentage = totalVisits ? (moduleData.visits / totalVisits * 100).toFixed(1) : '0.0';
        const visitBarWidth = totalVisits ? (moduleData.visits / totalVisits * 100) : 0;
        
        // 创建行内容
        row.innerHTML = `
          <td class="module-name">
            <i class="fa-solid ${moduleIcons[moduleId] || 'fa-file'} module-icon" style="background-color: ${moduleColors[moduleId] || '#1a3e72'}"></i>
            <span>${moduleNames[moduleId] || moduleId}</span>
            ${moduleData.active > moduleData.visits/2 ? '<span class="tag tag-active">活跃</span>' : ''}
          </td>
          <td>${moduleData.visits || 0}</td>
          <td class="time-spent">
            <i class="fa-solid fa-clock-rotate-left time-icon"></i>
            ${formatTimeSpent(avgTimeSpent)}
          </td>
          <td>${moduleData.active || 0}</td>
          <td>${moduleData.lastVisit ? formatDate(moduleData.lastVisit) : '未访问'}</td>
          <td>
            ${visitPercentage}%
            <div class="visit-bar" style="width: ${visitBarWidth}%"></div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
    }
    
    // 显示工具提示
    function showTooltip(event, text) {
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = text;
      tooltip.style.left = `${event.pageX + 10}px`;
      tooltip.style.top = `${event.pageY + 10}px`;
      tooltip.style.opacity = '1';
      tooltip.style.transform = 'translateY(0)';
    }
    
    // 隐藏工具提示
    function hideTooltip() {
      const tooltip = document.getElementById('tooltip');
      tooltip.style.opacity = '0';
      tooltip.style.transform = 'translateY(10px)';
    }

    // 初始化图表尺寸
    function initCanvasSizes() {
      const modulesCanvas = document.getElementById('modules-chart');
      const trendCanvas = document.getElementById('trend-chart');
      const timeDistCanvas = document.getElementById('time-distribution-chart');
      const timeSpentCanvas = document.getElementById('time-spent-chart');
      
      modulesCanvas.width = modulesCanvas.parentElement.offsetWidth * 0.9;
      modulesCanvas.height = 340;
      
      trendCanvas.width = trendCanvas.parentElement.offsetWidth * 0.9;
      trendCanvas.height = 340;
      
      timeDistCanvas.width = timeDistCanvas.parentElement.offsetWidth * 0.9;
      timeDistCanvas.height = 340;
      
      timeSpentCanvas.width = timeSpentCanvas.parentElement.offsetWidth * 0.9;
      timeSpentCanvas.height = 340;
    }

    // 初始化页面
    async function initPage() {
      initCanvasSizes();
      
      // 添加测试函数调用
      testApiConnection();
      
      const timeRange = document.getElementById('time-range').value;
      const stats = await fetchStatsData(timeRange);
      
      // 保存到本地缓存
      localStorage.setItem('moduleVisitStats', JSON.stringify(stats));
      
      updateSummaryStats(stats);
      updateModulesChart(stats);
      updateTrendChart(stats);
      updateTimeDistributionChart(stats);
      updateTimeSpentChart(stats);
      updateModulesTable(stats);
    }

    // 测试API连接和数据处理
    async function testApiConnection() {
      try {
        console.log('=== 开始测试API连接 ===');
        const apiUrl = `http://${window.location.hostname}:22223/api/stats?days=30`;
        console.log(`测试请求: ${apiUrl}`);
        
        // 尝试直接使用XMLHttpRequest，避免CORS问题
        const xhr = new XMLHttpRequest();
        xhr.open('GET', apiUrl, true);
        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            console.log('API连接成功!');
            try {
              const data = JSON.parse(xhr.responseText);
              console.log('解析数据成功:', data);
              
              // 检查general-case模块
              if (data['general-case']) {
                const gc = data['general-case'];
                console.log('测试 general-case 数据:');
                console.log('- visits:', gc.visits);
                console.log('- timeSpent:', gc.timeSpent);
                console.log('- avgTimeSpent:', gc.avgTimeSpent);
                console.log('- avgTimeSpent 类型:', typeof gc.avgTimeSpent);
                
                // 测试格式化函数
                console.log('格式化测试:');
                console.log('- formatTimeSpent(0):', formatTimeSpent(0));
                console.log('- formatTimeSpent(0.5):', formatTimeSpent(0.5));
                console.log('- formatTimeSpent(7):', formatTimeSpent(7));
                console.log('- formatTimeSpent("7"):', formatTimeSpent("7"));
                console.log('- formatTimeSpent(gc.avgTimeSpent):', formatTimeSpent(gc.avgTimeSpent));
                
                // 测试访问调试接口
                testDebugApi();
              }
            } catch (e) {
              console.error('解析数据失败:', e);
            }
          } else {
            console.error('API请求失败:', xhr.status, xhr.statusText);
          }
        };
        xhr.onerror = function() {
          console.error('API请求错误!');
        };
        xhr.send();
      } catch (e) {
        console.error('测试API连接失败:', e);
      }
    }
    
    // 测试调试API
    function testDebugApi() {
      try {
        const debugUrl = `http://${window.location.hostname}:22223/api/debug`;
        console.log(`测试调试API: ${debugUrl}`);
        
        fetch(debugUrl)
          .then(response => response.json())
          .then(data => {
            console.log('调试API返回数据:', data);
          })
          .catch(error => {
            console.error('调试API请求失败:', error);
          });
      } catch (e) {
        console.error('测试调试API失败:', e);
      }
    }

    // 窗口大小变化时重绘图表
    window.addEventListener('resize', function() {
      initCanvasSizes();
      // 使用已加载的数据重绘图表，避免重复请求
      const statsData = localStorage.getItem('moduleVisitStats');
      if (statsData) {
        try {
          const stats = JSON.parse(statsData);
          updateModulesChart(stats);
          updateTrendChart(stats);
          updateTimeDistributionChart(stats);
          updateTimeSpentChart(stats);
        } catch (e) {
          console.error('重绘图表出错:', e);
        }
      }
    });

    // 时间范围变化事件
    document.getElementById('time-range').addEventListener('change', function() {
      initPage();
    });

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html> 